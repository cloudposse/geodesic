#!/bin/bash
# Please run the following commands to start the geodesic shell (modify as necessary)
DOCKER_IMAGE=${DOCKER_IMAGE:-cloudposse/geodesic}
DOCKER_TAG=${DOCKER_TAG:-latest}
STATE_DIR=${STATE_DIR:-${HOME}/.geodesic}
OS=$(uname -s)
mkdir -p ${STATE_DIR}

if ! which docker > /dev/null; then
  echo "Cannot find docker installed on this system. Please install and try again."
  exit 1
fi

if [ -t 1 ]; then
  # Running in terminal 
  DOCKER_ARGS=(-it --env LS_COLORS --env TERM --env TERM_COLOR)

  if [ -n "$SSH_AUTH_SOCK" ]; then
    if [ `uname -s` == 'Darwin' ]; then
      # Run our own SSH agent
      DOCKER_ARGS=("${DOCKER_ARGS[@]}"
                     --volume "${HOME}/.ssh:/geodesic/.ssh" )
    else
      DOCKER_ARGS=("${DOCKER_ARGS[@]}"
                     --volume "$SSH_AUTH_SOCK:$SSH_AUTH_SOCK" 
                     --env SSH_AUTH_SOCK
                     --env SSH_CLIENT
                     --env SSH_CONNECTION
                     --env SSH_TTY 
                     --env USER)
    fi
  fi
else
  DOCKER_ARGS=()
fi

if [ "${OS}" == "Darwin" ]; then
  # Run in privleged mode to enable time synchronization of system clock with hardware clock
  # Implement DNS fix related to https://github.com/docker/docker/issues/24344
  DOCKER_ARGS=("${DOCKER_ARGS[@]}"
                --dns=8.8.8.8
              )
fi

DOCKER_ARGS=("${DOCKER_ARGS[@]}"
              --privileged
              --publish 8001:8001
              --rm 
              --env BOOTSTRAP=false
              --volume ${STATE_DIR}:/geodesic/state)

docker run "${DOCKER_ARGS[@]}" ${DOCKER_IMAGE}:${DOCKER_TAG} $*
