#!/usr/bin/env bash
# This script sets up a Terraform backend for a given project using envs

shopt -s nullglob
TF_BUCKET_REGION=${TF_BUCKET_REGION:-${AWS_REGION}}
TF_BUCKET_PREFIX=${TF_BUCKET_PREFIX:-$(basename $(pwd))}
TF_DIR=${@:-1}
TF_FILE=${TF_FILE:-terraform.tfstate}
TF_FILES=(*.tf *.tfvars)
TF_ARGS=("-backend=true")

# Disable color if not running in a TTY
if [ ! -t 1 ]; then
	TF_ARGS+=("-no-color")
fi

if [ ! -z ${TF_FILES} ] && [ -z "${TF_FROM_MODULE}" ]; then
	echo "Run $0 from a terraform project directory"
	exit 1
fi

[ -z "${TF_FROM_MODULE}" ] || TF_ARGS+=("-from-module=${TF_FROM_MODULE}")
[ -z "${TF_FILE}" ] || TF_ARGS+=("-backend-config=key=${TF_BUCKET_PREFIX}/${TF_FILE}")
[ -z "${TF_BUCKET}" ] || TF_ARGS+=("-backend-config=bucket=${TF_BUCKET}")
[ -z "${TF_BUCKET_REGION}" ] || TF_ARGS+=("-backend-config=region=${TF_BUCKET_REGION}")
[ -z "${TF_DYNAMODB_TABLE}" ] || TF_ARGS+=("-backend-config=dynamodb_table=${TF_DYNAMODB_TABLE}")
[ -z "${AWS_PROFILE}" ] || TF_ARGS+=("-backend-config=profile=${AWS_PROFILE}")
[ -z "${AWS_ROLE_ARN}" ] || TF_ARGS+=("-backend-config=role_arn=${AWS_ROLE_ARN}")

s3 mount

terraform init ${TF_ARGS[@]} $*

if [ -d "${TF_DIR}" ] && [ -n "${TF_FILES}" ]; then
	cp ${TF_FILES} "${TF_DIR}"
fi

