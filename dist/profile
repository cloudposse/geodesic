#!/bin/bash

if [ "${BOOTSTRAP}" == "true" ]; then
stty -onlcr
cat<<"__EOF__"
# Please run the following commands to start the geodesic shell (modify as necessary)
DOCKER_IMAGE=${DOCKER_IMAGE:-cloudposse/geodesic}
DOCKER_TAG=${DOCKER_TAG:-dev}
STATE_DIR=${STATE_DIR:-${HOME}/.geodesic}
mkdir -p ${STATE_DIR}
if [ -t 1 ]; then
  # Running in terminal 
  DOCKER_ARGS=(-it --env LS_COLORS --env TERM --env TERM_COLOR)

  if [ -n "$SSH_AUTH_SOCK" ]; then
    if [ `uname -s` == 'Darwin' ]; then
      # Run our own SSH agent
      DOCKER_ARGS=("${DOCKER_ARGS[@]}"
                     --volume "${HOME}/.ssh:/geodesic/.ssh" )
    else
      DOCKER_ARGS=("${DOCKER_ARGS[@]}"
                     --volume "$SSH_AUTH_SOCK:$SSH_AUTH_SOCK" 
                     --env SSH_AUTH_SOCK
                     --env SSH_CLIENT
                     --env SSH_CONNECTION
                     --env SSH_TTY 
                     --env USER)
    fi
  fi
else
  DOCKER_ARGS=()
fi

DOCKER_ARGS=("${DOCKER_ARGS[@]}"
              --rm 
              --env BOOTSTRAP=false
              --volume ${STATE_DIR}:/geodesic/state)

docker run "${DOCKER_ARGS[@]}" ${DOCKER_IMAGE}:${DOCKER_TAG} $*
__EOF__
exit 0
fi

echo "Entering the geodesic shell..."

# Create directories
mkdir -p $(dirname ${TF_STATE_FILE})
mkdir -p $(dirname ${KUBECONFIG})
mkdir -p $(dirname ${AWS_SHARED_CREDENTIALS_FILE})
mkdir -p $(dirname ${AWS_CONFIG_FILE})
mkdir -p ${AWS_DATA_PATH}

# Workaround for aws-cli which does not respect AWS_DATA_PATH
ln -sf ${AWS_DATA_PATH} ${HOME}/.aws

if [ -z "${SSH_AUTH_SOCK}" ]; then
  eval $(ssh-agent)
  if [ -f "${GEODESIC_PATH}/state/kops/id_rsa" ]; then
	  ssh-add "${GEODESIC_PATH}/state/kops/id_rsa"
  fi 
fi

# Import aws-assumed-role
. /usr/local/bin/profile

# Define our own prompt
function geodesic-prompt() {
  if [ -f "${CLOUD_CONFIG}" ]; then
		set -o allexport
		. "${CLOUD_CONFIG}"
		set +o allexport
  fi
  console-prompt
  if [ -n "${CLUSTER_NAME}" ]; then
    PS1="[${CLUSTER_NAME}]\n$PS1"
  fi
}

export PROMPT_COMMAND=geodesic-prompt

if [ -f "${GEODESIC_PATH}/motd" ]; then
  cat "${GEODESIC_PATH}/motd"
fi
